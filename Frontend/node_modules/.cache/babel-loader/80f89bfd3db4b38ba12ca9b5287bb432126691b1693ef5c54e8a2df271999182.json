{"ast":null,"code":"import React,{createContext,useContext,useState,useEffect,useCallback}from'react';import{authAPI,userAPI}from'../services/api';import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext();/**\n * HOW THE BACKEND AUTH WORKS (from reading source code):\n *\n * 1. POST /api/auth/login?email=X&password=Y  (RequestParam, NOT body)\n *    → Returns plain String JWT  e.g. \"eyJhbGci...\"\n *    → JWT subject = email\n *    → Expiry = 1 hour\n *\n * 2. POST /api/auth/register  { name, email, password, phoneNumber }\n *    → Returns plain String \"User registered successfully\"\n *    → Auto-login after successful register\n *\n * 3. To get user info after login:\n *    → Decode JWT subject (= email)\n *    → GET /api/users (requires auth) → find user by email\n *    → Store { id, name, email, phoneNumber } in localStorage\n *\n * 4. No /me endpoint, no refresh token\n */// Manually decode JWT payload (no library needed for this)\nconst decodeJwt=token=>{try{const base64=token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(base64));}catch(_unused){return null;}};export const AuthProvider=_ref=>{var _user$roles;let{children}=_ref;const[user,setUser]=useState(null);const[loading,setLoading]=useState(false);const[error,setError]=useState(null);// Restore session on mount\nuseEffect(()=>{const token=localStorage.getItem('jwt_token');const saved=localStorage.getItem('user_data');if(token&&saved){const decoded=decodeJwt(token);// Check token not expired\nif(decoded&&decoded.exp*1000>Date.now()){setUser(JSON.parse(saved));}else{localStorage.removeItem('jwt_token');localStorage.removeItem('user_data');}}// Listen for token expiry events from axios interceptor\nconst handleExpired=()=>{setUser(null);alert('Your session has expired. Please sign in again.');};window.addEventListener('bms_session_expired',handleExpired);return()=>window.removeEventListener('bms_session_expired',handleExpired);},[]);/**\n   * Fetch user data from backend using JWT token\n   * Backend has no /me endpoint, so we GET /api/users and filter by email\n   */const fetchUserData=async email=>{try{const res=await userAPI.getAll();const found=res.data.find(u=>u.email===email);if(found)return found;// { id, name, email, phoneNumber }\n}catch(_unused2){// If /api/users is not accessible (shouldn't happen for USER role)\n}// Fallback — store just email if user fetch fails\nreturn{email,name:email.split('@')[0]};};/**\n   * LOGIN\n   * Backend: POST /api/auth/login?email=&password= (RequestParam!)\n   * Returns: plain String JWT\n   */const login=async(email,password)=>{setLoading(true);setError(null);try{var _res$data;const res=await authAPI.login(email,password);// Response data is a plain string JWT\nconst token=typeof res.data==='string'?res.data.trim():(_res$data=res.data)===null||_res$data===void 0?void 0:_res$data.token;if(!token)throw new Error('No token received');localStorage.setItem('jwt_token',token);// Get email from JWT, then fetch full user data\nconst decoded=decodeJwt(token);const userEmail=(decoded===null||decoded===void 0?void 0:decoded.sub)||email;const userData=await fetchUserData(userEmail);localStorage.setItem('user_data',JSON.stringify(userData));setUser(userData);return{ok:true};}catch(e){var _e$response,_e$response$data,_e$response2,_e$response3;// Backend returns 500 for bad credentials (GlobalExceptionHandler bug)\n// or 401 from Spring Security\nconst msg=((_e$response=e.response)===null||_e$response===void 0?void 0:(_e$response$data=_e$response.data)===null||_e$response$data===void 0?void 0:_e$response$data.message)||((_e$response2=e.response)===null||_e$response2===void 0?void 0:_e$response2.data)||(((_e$response3=e.response)===null||_e$response3===void 0?void 0:_e$response3.status)===401?'Invalid email or password.':'Login failed. Please try again.');setError(typeof msg==='string'?msg:'Login failed.');return{ok:false};}finally{setLoading(false);}};/**\n   * REGISTER\n   * Backend: POST /api/auth/register { name, email, password, phoneNumber }\n   * phoneNumber is NOT NULL in DB — required\n   * Returns: plain String \"User registered successfully\"\n   * We auto-login after success.\n   */const register=async(name,email,password,phoneNumber)=>{setLoading(true);setError(null);try{await authAPI.register(name,email,password,phoneNumber||'0000000000');// Auto login after register\nreturn await login(email,password);}catch(e){var _e$response4;const raw=(_e$response4=e.response)===null||_e$response4===void 0?void 0:_e$response4.data;const msg=(typeof raw==='string'?raw:raw===null||raw===void 0?void 0:raw.message)||'Registration failed.';// Common case: \"Email already exists\" thrown as RuntimeException → 500\nsetError(msg.includes('Email already exists')?'This email is already registered.':msg);return{ok:false};}finally{setLoading(false);}};const logout=useCallback(()=>{localStorage.removeItem('jwt_token');localStorage.removeItem('user_data');setUser(null);},[]);const isAdmin=(user===null||user===void 0?void 0:(_user$roles=user.roles)===null||_user$roles===void 0?void 0:_user$roles.some(r=>(typeof r==='string'?r:r===null||r===void 0?void 0:r.name)==='ADMIN'))||false;return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,loading,error,setError,login,register,logout,isAdmin},children:children});};export const useAuth=()=>useContext(AuthContext);","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","authAPI","userAPI","jsx","_jsx","AuthContext","decodeJwt","token","base64","split","replace","JSON","parse","atob","_unused","AuthProvider","_ref","_user$roles","children","user","setUser","loading","setLoading","error","setError","localStorage","getItem","saved","decoded","exp","Date","now","removeItem","handleExpired","alert","window","addEventListener","removeEventListener","fetchUserData","email","res","getAll","found","data","find","u","_unused2","name","login","password","_res$data","trim","Error","setItem","userEmail","sub","userData","stringify","ok","e","_e$response","_e$response$data","_e$response2","_e$response3","msg","response","message","status","register","phoneNumber","_e$response4","raw","includes","logout","isAdmin","roles","some","r","Provider","value","useAuth"],"sources":["C:/Users/divya/Downloads/Movie Booking Frontend/Frontend/src/context/AuthContext.jsx"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\nimport { authAPI, userAPI } from '../services/api';\n\nconst AuthContext = createContext();\n\n/**\n * HOW THE BACKEND AUTH WORKS (from reading source code):\n *\n * 1. POST /api/auth/login?email=X&password=Y  (RequestParam, NOT body)\n *    → Returns plain String JWT  e.g. \"eyJhbGci...\"\n *    → JWT subject = email\n *    → Expiry = 1 hour\n *\n * 2. POST /api/auth/register  { name, email, password, phoneNumber }\n *    → Returns plain String \"User registered successfully\"\n *    → Auto-login after successful register\n *\n * 3. To get user info after login:\n *    → Decode JWT subject (= email)\n *    → GET /api/users (requires auth) → find user by email\n *    → Store { id, name, email, phoneNumber } in localStorage\n *\n * 4. No /me endpoint, no refresh token\n */\n\n// Manually decode JWT payload (no library needed for this)\nconst decodeJwt = (token) => {\n  try {\n    const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');\n    return JSON.parse(atob(base64));\n  } catch {\n    return null;\n  }\n};\n\nexport const AuthProvider = ({ children }) => {\n  const [user, setUser]       = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError]     = useState(null);\n\n  // Restore session on mount\n  useEffect(() => {\n    const token = localStorage.getItem('jwt_token');\n    const saved = localStorage.getItem('user_data');\n    if (token && saved) {\n      const decoded = decodeJwt(token);\n      // Check token not expired\n      if (decoded && decoded.exp * 1000 > Date.now()) {\n        setUser(JSON.parse(saved));\n      } else {\n        localStorage.removeItem('jwt_token');\n        localStorage.removeItem('user_data');\n      }\n    }\n\n    // Listen for token expiry events from axios interceptor\n    const handleExpired = () => {\n      setUser(null);\n      alert('Your session has expired. Please sign in again.');\n    };\n    window.addEventListener('bms_session_expired', handleExpired);\n    return () => window.removeEventListener('bms_session_expired', handleExpired);\n  }, []);\n\n  /**\n   * Fetch user data from backend using JWT token\n   * Backend has no /me endpoint, so we GET /api/users and filter by email\n   */\n  const fetchUserData = async (email) => {\n    try {\n      const res = await userAPI.getAll();\n      const found = res.data.find(u => u.email === email);\n      if (found) return found; // { id, name, email, phoneNumber }\n    } catch {\n      // If /api/users is not accessible (shouldn't happen for USER role)\n    }\n    // Fallback — store just email if user fetch fails\n    return { email, name: email.split('@')[0] };\n  };\n\n  /**\n   * LOGIN\n   * Backend: POST /api/auth/login?email=&password= (RequestParam!)\n   * Returns: plain String JWT\n   */\n  const login = async (email, password) => {\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await authAPI.login(email, password);\n      // Response data is a plain string JWT\n      const token = typeof res.data === 'string' ? res.data.trim() : res.data?.token;\n      if (!token) throw new Error('No token received');\n\n      localStorage.setItem('jwt_token', token);\n\n      // Get email from JWT, then fetch full user data\n      const decoded = decodeJwt(token);\n      const userEmail = decoded?.sub || email;\n      const userData = await fetchUserData(userEmail);\n\n      localStorage.setItem('user_data', JSON.stringify(userData));\n      setUser(userData);\n      return { ok: true };\n    } catch (e) {\n      // Backend returns 500 for bad credentials (GlobalExceptionHandler bug)\n      // or 401 from Spring Security\n      const msg =\n        e.response?.data?.message ||\n        e.response?.data ||\n        (e.response?.status === 401 ? 'Invalid email or password.' : 'Login failed. Please try again.');\n      setError(typeof msg === 'string' ? msg : 'Login failed.');\n      return { ok: false };\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * REGISTER\n   * Backend: POST /api/auth/register { name, email, password, phoneNumber }\n   * phoneNumber is NOT NULL in DB — required\n   * Returns: plain String \"User registered successfully\"\n   * We auto-login after success.\n   */\n  const register = async (name, email, password, phoneNumber) => {\n    setLoading(true);\n    setError(null);\n    try {\n      await authAPI.register(name, email, password, phoneNumber || '0000000000');\n      // Auto login after register\n      return await login(email, password);\n    } catch (e) {\n      const raw = e.response?.data;\n      const msg =\n        (typeof raw === 'string' ? raw : raw?.message) ||\n        'Registration failed.';\n      // Common case: \"Email already exists\" thrown as RuntimeException → 500\n      setError(msg.includes('Email already exists') ? 'This email is already registered.' : msg);\n      return { ok: false };\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const logout = useCallback(() => {\n    localStorage.removeItem('jwt_token');\n    localStorage.removeItem('user_data');\n    setUser(null);\n  }, []);\n\n  const isAdmin = user?.roles?.some(r =>\n    (typeof r === 'string' ? r : r?.name) === 'ADMIN'\n  ) || false;\n\n  return (\n    <AuthContext.Provider value={{ user, loading, error, setError, login, register, logout, isAdmin }}>\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport const useAuth = () => useContext(AuthContext);"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}